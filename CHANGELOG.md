# Changelog

Все значимые изменения в проекте AI Petrovich документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
версионирование следует [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Планируется
- Добавить retry логику для Claude API с экспоненциальным backoff
- Добавить CloudWatch метрики для мониторинга
- Параллельная обработка SQS records через ThreadPoolExecutor
- Использование AWS Secrets Manager вместо переменных окружения
- Unit тесты для критических функций
- Integration тесты с mock DynamoDB и SQS
- Прогноз погоды (forecast) через OpenWeatherMap API

## [1.2.0] - 2026-02-13

### Добавлено

#### Дата/время в контексте модели
- Текущая дата и время МСК автоматически передаётся в каждый запрос к Claude
- Модель корректно отвечает на вопросы "какое сегодня число", "на завтра" и т.д.

#### Погода через Claude Tool Use
- Реализован механизм **Tool Use** в `claude_utils.py`:
  - `_chat()` поддерживает цикл вызова инструментов (`stop_reason == "tool_use"`)
  - `generate_response()` принимает параметры `tools` и `tool_executor`
- Инструмент `get_weather` через OpenWeatherMap API:
  - Claude сам извлекает название города из сообщения пользователя
  - Если город не указан — используется `WEATHER_DEFAULT_CITY` (по умолчанию Moscow)
  - Возвращает температуру, ощущаемую температуру, влажность, скорость ветра
- Новые переменные окружения: `OPENWEATHERMAP_API_KEY`, `WEATHER_DEFAULT_CITY`

#### Обработка отредактированных сообщений
- `webhook_lambda.py` и `worker_lambda.py` теперь обрабатывают `edited_message`
- Бот реагирует на упоминание в отредактированном сообщении

#### Деплой через AWS CLI
- Установлен AWS CLI v2 и настроен IAM пользователь для деплоя
- Добавлена переменная `MESSAGES_TABLE` (ранее отсутствовала в env vars)
- Корректный `BASE_SYSTEM_PROMPT` через Python/boto3 (решена проблема кодировки)

### Исправлено
- **SQS InvalidParameterValue**: атрибуты с пустым значением (`thread_id`, `user_id` для каналов) теперь не отправляются в SQS
- **DynamoDB ValidationException**: при обновлении профиля старых пользователей (без поля `profile`) теперь автоматически инициализируется структура профиля и повторяется запрос — затрагивает `update_user_profile()` и `update_user_names()`

## [1.1.0] - 2025-01-20

### Добавлено

#### Персонализация и долгосрочная память
- **Извлечение полных данных пользователя** из Telegram API (`first_name`, `last_name`)
- **Структура User Profile** в DynamoDB:
  - `first_name`, `last_name` - реальные имена пользователей
  - `communication_style` - автоматически определяемый стиль общения
  - `interests` - список интересов (автоматическое извлечение)
  - `long_term_summary` - долгосрочная сводка о пользователе
  - `last_topics` - последние обсуждаемые темы
  - `message_count` - счётчик сообщений

#### Новые функции в dynamo_utils.py
- `update_user_names()` - обновление имён при изменении в Telegram
- `update_user_profile()` - обновление долгосрочной информации
- `get_user_profile()` - получение профиля пользователя
- Расширена `save_user()` для инициализации profile структуры

#### Улучшенная саммаризация (claude_utils.py)
- `summarize_history()` теперь:
  - Использует 30 сообщений вместо 16 (+87%)
  - Выделяет 600 токенов вместо 200 (+200%)
  - Сохраняет имена и стиль общения участников
  - Принимает опциональный `user_context`
- `create_long_term_summary()` - создание профиля пользователя:
  - Анализирует последние 60 сообщений
  - Определяет стиль общения, интересы, проекты
  - Генерирует 1-2 абзаца профиля (400 токенов)
- `extract_topics()` - извлечение ключевых тем:
  - Анализирует последние 10 сообщений
  - Возвращает до 5 ключевых тем/слов

#### Обогащённый контекст для модели (worker_lambda.py)

**Для приватных чатов:**
- Персональный блок в system prompt:
  ```
  О собеседнике (Иван @ivan_petrov):
  - Стиль общения: Технический, прямой
  - Интересы: Python, AWS Lambda, Claude API
  - Контекст прошлых бесед: ...
  - Последние темы: Docker, DynamoDB
  ```

**Для групповых чатов:**
- Карта участников с именами:
  ```
  Участники беседы:
  - Иван (@ivan_petrov), ID:123456 — текущий автор
  - Мария (@maria_dev), ID:789012 — участник
  ```

**Улучшенные префиксы сообщений:**
- Было: `[user:123456789] Привет`
- Стало: `[Иван (@ivan_petrov), ID:123456789] Привет`

#### Автоматическое обновление профилей
- Счётчик сообщений обновляется после каждого диалога
- Долгосрочная сводка создаётся после 50+ сообщений
- Темы извлекаются из последних 20 сообщений
- Кеширование профилей в рамках одного execution

#### Документация
- `PROJECT_CONTEXT.md` - полный контекст проекта для AI ассистентов
- `CHANGELOG.md` - этот файл с историей изменений
- Обновлён `README.md` с новыми возможностями

#### Инфраструктура
- `.gitignore` для защиты чувствительных данных
- Git репозиторий инициализирован
- Проект загружен на GitHub

### Изменено
- `_parse_update()` в worker_lambda.py теперь извлекает `first_name` и `last_name`
- `_process_one()` обновляет профили при каждом сообщении
- Формирование контекста учитывает профили всех участников
- Scope инструкции обновлены для работы с именами

### Исправлено
- Удалён проблемный файл `nul` из репозитория
- Исправлены предупреждения git о line endings (CRLF/LF)

## [1.0.0] - 2025-01-15

### Добавлено

#### Базовая функциональность
- Асинхронная архитектура через AWS Lambda + SQS
- Интеграция с Anthropic Claude API (Sonnet 4.5)
- Поддержка Telegram Bot API

#### Lambda функции
- `webhook_lambda.py` - приём webhook от Telegram, отправка в SQS
- `worker_lambda.py` - обработка сообщений, генерация ответов
- `cleanup_function.py` - очистка старых данных (через DynamoDB TTL)

#### Утилиты
- `claude_utils.py` - интеграция с Claude API, базовая саммаризация
- `dynamo_utils.py` - CRUD операции для DynamoDB
- `telegram_utils.py` - отправка сообщений в Telegram

#### База данных (DynamoDB)
- Таблица **Users** - информация о пользователях
- Таблица **Channels** - группы и каналы
- Таблица **Threads** - треды в форумах
- Таблица **Messages** - история сообщений с TTL 1 год
- Таблица **Summaries** - сводки диалогов
- Таблица **Settings** - настройки режима работы

#### Режимы работы
- `/mode always` - всегда отвечать в группе
- `/mode mention` - только при упоминании
- `/mode off` - не отвечать

#### Scope в группах
- `/scope initiator` - учитывать только инициатора
- `/scope thread` - все участники треда
- `/scope hybrid` - приоритет инициатору, контекст других

#### Особенности
- Поддержка FIFO очередей с дедупликацией
- Умное обрезание контекста с сохранением приоритетов
- Базовая саммаризация диалогов
- Поддержка тредов, каналов, форумов
- Разделение сообщений на части до 4000 символов

#### Lambda Layer
- Docker-based сборка для независимости от ОС
- `Dockerfile` для Python 3.11
- `build_layer.bat` для Windows
- `build_layer.sh` для Linux/Mac
- `requirements.txt` с зависимостями

#### Документация
- `README.md` - общее описание проекта
- `README_ASYNC.md` - асинхронная архитектура
- `README_LAYER.md` - инструкции по Lambda Layer

### Технические детали
- Python 3.11
- AWS Lambda runtime
- Amazon SQS для асинхронной обработки
- Amazon DynamoDB для хранения данных
- Anthropic Claude API (Sonnet 4.5)

---

## Типы изменений

- `Added` - новая функциональность
- `Changed` - изменения в существующей функциональности
- `Deprecated` - функциональность, которая будет удалена
- `Removed` - удалённая функциональность
- `Fixed` - исправления багов
- `Security` - исправления безопасности

## Ссылки

- [GitHub Repository](https://github.com/CruxForever/AI_Telegram_bot)
- [Claude API Documentation](https://docs.anthropic.com/)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [AWS Lambda](https://aws.amazon.com/lambda/)
